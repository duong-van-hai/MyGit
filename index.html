<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω B√†i T·∫≠p - Phi√™n B·∫£n Gi√°o Vi√™n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { padding: 20px; border: 2px solid #eee; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.3s; background: #fff; }
        .card:hover { border-color: var(--secondary); background: #f1f9ff; transform: translateY(-3px); }
        button { background: var(--secondary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .timer { position: fixed; top: 20px; right: 20px; background: var(--danger); color: white; padding: 12px 25px; border-radius: 50px; font-weight: bold; z-index: 100; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f9fa; }
        .quiz-item-row { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .btn-delete { background: var(--danger); padding: 5px 10px; font-size: 12px; }
        .teacher-sec { margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="role-page">
        <h1 style="text-align:center; color: var(--primary);">H·ªÜ TH·ªêNG QU·∫¢N L√ù GI√ÅO D·ª§C</h1>
        <div class="menu-grid">
            <div class="card" onclick="showPage('student-auth')"><h2>üë®‚Äçüéì H·ªåC SINH</h2><p>L√†m b√†i t·∫≠p & Xem ƒëi·ªÉm</p></div>
            <div class="card" onclick="showPage('teacher-auth')"><h2>üë®‚Äçüè´ GI√ÅO VI√äN</h2><p>Qu·∫£n l√Ω ƒë·ªÅ & Xem k·∫øt qu·∫£</p></div>
        </div>
    </div>

    <div id="student-auth" class="hidden">
        <button onclick="showPage('role-page')">‚Üê Quay l·∫°i</button>
        <h2>Th√¥ng tin h·ªçc sinh</h2>
        <input type="text" id="std-name" placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa em...">
        <button onclick="loginStudent()" style="width:100%">ƒêƒÇNG NH·∫¨P V√ÄO L·ªöP</button>
    </div>

    <div id="student-home" class="hidden">
        <h2 id="welcome-std" style="color: var(--secondary);"></h2>
        <div class="menu-grid">
            <div class="card" onclick="showTheory()">üìñ B√†i H·ªçc L√Ω Thuy·∫øt</div>
            <div class="card" onclick="showQuizListForStudent()">üìù Danh S√°ch B√†i T·∫≠p</div>
        </div>
        <button onclick="showPage('role-page')" style="background:var(--danger); margin-top:20px">ƒêƒÉng xu·∫•t</button>
    </div>

    <div id="teacher-auth" class="hidden">
        <button onclick="showPage('role-page')">‚Üê Quay l·∫°i</button>
        <h2>Khu v·ª±c Gi√°o vi√™n</h2>
        <input type="password" id="tea-pass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n l√Ω">
        <button onclick="loginTeacher()" style="width:100%">V√ÄO H·ªÜ TH·ªêNG</button>
    </div>

    <div id="teacher-home" class="hidden">
        <h2 style="border-bottom: 2px solid var(--secondary); padding-bottom: 10px;">B·∫£ng ƒêi·ªÅu Khi·ªÉn Gi√°o Vi√™n</h2>
        <div class="menu-grid" style="grid-template-columns: repeat(2, 1fr);">
            <button onclick="showTeacherSection('create-theory')">üìù L√Ω Thuy·∫øt</button>
            <button onclick="showTeacherSection('create-quiz')">‚ûï T·∫°o B√†i M·ªõi</button>
            <button onclick="manageQuizzes()">üìã Qu·∫£n L√Ω ƒê·ªÅ</button>
            <button onclick="showResults()">üìä B·∫£ng ƒêi·ªÉm</button>
        </div>
        
        <div id="create-theory" class="teacher-sec hidden">
            <h3>So·∫°n th·∫£o n·ªôi dung l√Ω thuy·∫øt</h3>
            <textarea id="theory-content" rows="10" placeholder="Nh·∫≠p ki·∫øn th·ª©c t·∫°i ƒë√¢y..."></textarea>
            <button onclick="saveTheory()" style="background: var(--success)">L∆∞u n·ªôi dung</button>
        </div>

        <div id="create-quiz" class="teacher-sec hidden">
            <h3>T·∫°o b√†i ki·ªÉm tra m·ªõi t·ª´ file Word</h3>
            <input type="text" id="quiz-name" placeholder="T√™n b√†i ki·ªÉm tra (VD: Ki·ªÉm tra 1 ti·∫øt)">
            <label>Th·ªùi gian:</label>
            <select id="set-duration">
                <option value="15">15 Ph√∫t</option>
                <option value="20">20 Ph√∫t</option>
                <option value="45">45 Ph√∫t</option>
            </select>
            <input type="file" id="word-file" accept=".docx">
            <button onclick="parseWordFile()" style="background: var(--success); width: 100%;">T·∫¢I ƒê·ªÄ L√äN DANH S√ÅCH</button>
        </div>

        <div id="quiz-manager-view" class="teacher-sec hidden">
            <h3>Danh s√°ch c√°c b√†i ki·ªÉm tra hi·ªán c√≥</h3>
            <div id="quiz-list-container"></div>
        </div>

        <div id="results-view" class="teacher-sec hidden"></div>
        
        <br>
        <button onclick="showPage('role-page')" style="background:var(--danger)">ƒêƒÉng xu·∫•t</button>
    </div>

    <div id="display-area" class="hidden">
        <div class="timer hidden" id="quiz-timer">00:00</div>
        <button onclick="exitContent()">‚Üê Quay l·∫°i Menu</button>
        <div id="content-body" style="margin-top:20px"></div>
    </div>
</div>

<script>
    // D·ªØ li·ªáu ban ƒë·∫ßu
    let db = JSON.parse(localStorage.getItem('edu_db_v4')) || {
        theory: "Ch∆∞a c√≥ n·ªôi dung l√Ω thuy·∫øt ƒë∆∞·ª£c c·∫≠p nh·∫≠t.",
        quizzes: [],
        results: []
    };

    function saveDB() { localStorage.setItem('edu_db_v4', JSON.stringify(db)); }

    function showPage(id) {
        document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function loginTeacher() {
        if(document.getElementById('tea-pass').value === '123') { // M·∫≠t kh·∫©u 123
            showPage('teacher-home');
        } else {
            alert('M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c!');
        }
    }

    function showTeacherSection(id) {
        document.querySelectorAll('.teacher-sec').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'create-theory') document.getElementById('theory-content').value = db.theory;
    }

    // --- QU·∫¢N L√ù B√ÄI KI·ªÇM TRA (GI√ÅO VI√äN) ---
    function manageQuizzes() {
        showTeacherSection('quiz-manager-view');
        const container = document.getElementById('quiz-list-container');
        container.innerHTML = "";
        
        if(db.quizzes.length === 0) {
            container.innerHTML = "<p>Ch∆∞a c√≥ b√†i ki·ªÉm tra n√†o.</p>";
            return;
        }

        db.quizzes.forEach((quiz, index) => {
            container.innerHTML += `
                <div class="quiz-item-row">
                    <div>
                        <strong>${quiz.name}</strong><br>
                        <small>S·ªë c√¢u: ${quiz.questions.length} | Th·ªùi gian: ${quiz.duration}p</small>
                    </div>
                    <button class="btn-delete" onclick="deleteQuiz(${index})">X√≥a b√†i</button>
                </div>`;
        });
    }

    function deleteQuiz(index) {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i ki·ªÉm tra n√†y kh√¥ng?")) {
            db.quizzes.splice(index, 1);
            saveDB();
            manageQuizzes();
        }
    }

    // --- X·ª¨ L√ù FILE WORD ---
    function parseWordFile() {
        const name = document.getElementById('quiz-name').value;
        const fileInput = document.getElementById('word-file');
        if (!name) return alert("Vui l√≤ng ƒë·∫∑t t√™n b√†i ki·ªÉm tra!");
        if (!fileInput.files[0]) return alert("Vui l√≤ng ch·ªçn file Word!");
        
        const reader = new FileReader();
        reader.onload = function(e) {
            mammoth.convertToHtml({arrayBuffer: e.target.result})
                .then(function(result) { processHtmlToQuestions(result.value, name); });
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function processHtmlToQuestions(html, quizName) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const paragraphs = Array.from(tempDiv.querySelectorAll('p')).map(p => p.innerHTML.trim()).filter(p => p !== "");
        
        let newQuestions = [];
        for(let i = 0; i < paragraphs.length; i += 5) {
            if(paragraphs[i+4]) {
                let options = [paragraphs[i+1], paragraphs[i+2], paragraphs[i+3], paragraphs[i+4]];
                let correctIdx = options.findIndex(opt => opt.includes('<u>'));
                newQuestions.push({
                    q: paragraphs[i].replace(/<\/?[^>]+(>|$)/g, ""),
                    a: options.map(opt => opt.replace(/<\/?[^>]+(>|$)/g, "")),
                    c: correctIdx !== -1 ? correctIdx : 0
                });
            }
        }
        
        if(newQuestions.length > 0) {
            db.quizzes.push({
                id: Date.now(),
                name: quizName,
                questions: newQuestions,
                duration: parseInt(document.getElementById('set-duration').value)
            });
            saveDB();
            alert("T·∫£i b√†i t·∫≠p th√†nh c√¥ng!");
            document.getElementById('quiz-name').value = "";
            manageQuizzes();
        } else {
            alert("L·ªói: Kh√¥ng t√¨m th·∫•y ƒë√°p √°n g·∫°ch ch√¢n ho·∫∑c sai ƒë·ªãnh d·∫°ng c√¢u h·ªèi!");
        }
    }

    // --- PH·∫¶N H·ªåC SINH ---
    let currentStudent = "";
    let activeQuiz = null;
    let timerInterval;

    function loginStudent() {
        currentStudent = document.getElementById('std-name').value;
        if(!currentStudent) return alert('Em ch∆∞a nh·∫≠p t√™n!');
        document.getElementById('welcome-std').innerText = "Ch√†o h·ªçc sinh: " + currentStudent;
        showPage('student-home');
    }

    function showQuizListForStudent() {
        showPage('display-area');
        let html = '<h2>Danh s√°ch b√†i t·∫≠p c·ªßa l·ªõp</h2>';
        if(db.quizzes.length === 0) {
            html += '<p>Hi·ªán t·∫°i gi√°o vi√™n ch∆∞a giao b√†i t·∫≠p n√†o.</p>';
        } else {
            db.quizzes.forEach(quiz => {
                html += `
                    <div class="quiz-item-row" style="background:#f9f9f9">
                        <span><strong>${quiz.name}</strong> (${quiz.duration} ph√∫t)</span>
                        <button onclick="runQuiz(${quiz.id})">B·∫Øt ƒë·∫ßu l√†m</button>
                    </div>`;
            });
        }
        document.getElementById('content-body').innerHTML = html;
    }

    function runQuiz(quizId) {
        activeQuiz = db.quizzes.find(q => q.id === quizId);
        const timerEl = document.getElementById('quiz-timer');
        timerEl.classList.remove('hidden');
        
        let html = `<h3>${activeQuiz.name}</h3>`;
        activeQuiz.questions.forEach((q, i) => {
            html += `<div style="margin-bottom:20px; padding:15px; border-bottom:1px solid #ddd">
                <p><strong>C√¢u ${i+1}: ${q.q}</strong></p>
                ${q.a.map((opt, idx) => `<label style="display:block; margin:5px 0"><input type="radio" name="q${i}" value="${idx}"> ${opt}</label>`).join('')}
            </div>`;
        });
        html += `<button onclick="finishQuiz()" style="background:var(--success); width:100%; padding:15px">N·ªòP B√ÄI</button>`;
        document.getElementById('content-body').innerHTML = html;

        let timeLeft = activeQuiz.duration * 60;
        timerInterval = setInterval(() => {
            timeLeft--;
            let min = Math.floor(timeLeft / 60);
            let sec = timeLeft % 60;
            timerEl.innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
            if(timeLeft <= 0) { clearInterval(timerInterval); finishQuiz(); }
        }, 1000);
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        document.getElementById('quiz-timer').classList.add('hidden');
        let correctCount = 0;
        activeQuiz.questions.forEach((q, i) => {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if(selected && parseInt(selected.value) === q.c) correctCount++;
        });

        const score = (correctCount/activeQuiz.questions.length*10).toFixed(1);
        db.results.push({ name: currentStudent, quiz: activeQuiz.name, score: score, date: new Date().toLocaleString() });
        saveDB();

        document.getElementById('content-body').innerHTML = `
            <div style="text-align:center; padding:20px">
                <h2 style="color:var(--danger)">Ho√†n th√†nh: ${score} ƒëi·ªÉm</h2>
                <p>B√†i: ${activeQuiz.name} | ƒê√∫ng: ${correctCount}/${activeQuiz.questions.length} c√¢u</p>
                <button onclick="showQuizListForStudent()">Quay l·∫°i danh s√°ch</button>
            </div>`;
    }

    function saveTheory() {
        db.theory = document.getElementById('theory-content').value;
        saveDB();
        alert('ƒê√£ l∆∞u l√Ω thuy·∫øt!');
    }

    function showTheory() {
        showPage('display-area');
        document.getElementById('content-body').innerHTML = `<h2>B√†i H·ªçc L√Ω Thuy·∫øt</h2><div style="white-space:pre-wrap; line-height:1.6">${db.theory}</div>`;
    }

    function showResults() {
