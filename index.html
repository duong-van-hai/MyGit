<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Snake Duo - Sâu Săn Mồi 2 Người</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #222; color: white; }
        canvas { border: 5px solid #444; background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .controls { margin: 20px; padding: 20px; background: #333; border-radius: 10px; text-align: center; }
        input { padding: 8px; border-radius: 5px; border: none; }
        button { padding: 8px 15px; border-radius: 5px; border: none; background: #28a745; color: white; cursor: pointer; font-weight: bold; }
        .status { margin-top: 10px; color: #ffc107; }
        .info { color: #aaa; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>SNAKE DUO 1vs1</h1>

    <div class="controls">
        <div id="peer-id-display">ID của bạn: Đang khởi tạo...</div>
        <div style="margin-top: 10px;">
            <input type="text" id="remote-id" placeholder="Nhập ID bạn bè">
            <button onclick="connectToFriend()">KẾT NỐI & CHƠI</button>
        </div>
        <div class="status" id="status">Chưa kết nối</div>
        <div class="info">Dùng mũi tên hoặc WASD để di chuyển</div>
    </div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const gridSize = 20;
    const tileCount = canvas.width / gridSize;

    // Trạng thái game
    let snake1 = [{x: 10, y: 10}];
    let snake2 = [{x: 5, y: 5}];
    let food = {x: 15, y: 15};
    let dir1 = {x: 0, y: 0};
    let dir2 = {x: 0, y: 0};
    
    let isHost = false;
    let conn;
    const peer = new Peer(); // Tạo ID ngẫu nhiên cho máy này

    // 1. Khởi tạo Peer
    peer.on('open', (id) => {
        document.getElementById('peer-id-display').innerText = "ID của bạn: " + id;
    });

    // 2. Chờ người khác kết nối tới mình (Máy chủ tạm thời)
    peer.on('connection', (c) => {
        conn = c;
        isHost = true;
        setupChat();
        document.getElementById('status').innerText = "Đã kết nối! Bạn là chủ phòng.";
        startGame();
    });

    // 3. Chủ động kết nối tới người khác (Máy khách)
    function connectToFriend() {
        const remoteId = document.getElementById('remote-id').value;
        conn = peer.connect(remoteId);
        isHost = false;
        setupChat();
        document.getElementById('status').innerText = "Đang kết nối...";
    }

    function setupChat() {
        conn.on('open', () => {
            document.getElementById('status').innerText = "Đã kết nối! Bắt đầu chơi.";
            startGame();
        });

        conn.on('data', (data) => {
            if (isHost) {
                // Nếu là Host, nhận phím bấm từ khách
                dir2 = data.dir;
            } else {
                // Nếu là Khách, nhận toàn bộ trạng thái game từ Host
                snake1 = data.s1;
                snake2 = data.s2;
                food = data.food;
            }
        });
    }

    // 4. Xử lý phím bấm
    window.addEventListener("keydown", e => {
        let newDir = {x: 0, y: 0};
        if (e.key === "ArrowUp" || e.key === "w") newDir = {x: 0, y: -1};
        else if (e.key === "ArrowDown" || e.key === "s") newDir = {x: 0, y: 1};
        else if (e.key === "ArrowLeft" || e.key === "a") newDir = {x: -1, y: 0};
        else if (e.key === "ArrowRight" || e.key === "d") newDir = {x: 1, y: 0};

        if (isHost) {
            dir1 = newDir;
        } else if (conn) {
            conn.send({ dir: newDir }); // Gửi hướng đi về Host
        }
    });

    // 5. Logic Game (Chỉ Host mới tính toán)
    function update() {
        if (!isHost) return;

        // Di chuyển rắn 1
        let head1 = {x: snake1[0].x + dir1.x, y: snake1[0].y + dir1.y};
        snake1.unshift(head1);
        if (head1.x === food.x && head1.y === food.y) {
            spawnFood();
        } else {
            if (dir1.x !== 0 || dir1.y !== 0) snake1.pop();
        }

        // Di chuyển rắn 2
        let head2 = {x: snake2[0].x + dir2.x, y: snake2[0].y + dir2.y};
        snake2.unshift(head2);
        if (head2.x === food.x && head2.y === food.y) {
            spawnFood();
        } else {
            if (dir2.x !== 0 || dir2.y !== 0) snake2.pop();
        }

        // Gửi dữ liệu cho khách
        if (conn && conn.open) {
            conn.send({ s1: snake1, s2: snake2, food: food });
        }
    }

    function spawnFood() {
        food = {
            x: Math.floor(Math.random() * tileCount),
            y: Math.floor(Math.random() * tileCount)
        };
    }

    function draw() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Vẽ rắn 1 (Bạn/Chủ) - Xanh lá
        ctx.fillStyle = "#2ecc71";
        snake1.forEach(p => ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize-2, gridSize-2));

        // Vẽ rắn 2 (Bạn bè/Khách) - Xanh dương
        ctx.fillStyle = "#3498db";
        snake2.forEach(p => ctx.fillRect(p.x * gridSize, p.y * gridSize, gridSize-2, gridSize-2));

        // Vẽ mồi - Đỏ
        ctx.fillStyle = "#e74c3c";
        ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize-2, gridSize-2);
    }

    function startGame() {
        setInterval(() => {
            update();
            draw();
        }, 150); // Tốc độ game
    }
</script>
</body>
</html>
